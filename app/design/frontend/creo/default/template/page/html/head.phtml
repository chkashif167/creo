<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magento.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magento.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2006-2015 X.commerce, Inc. (http://www.magento.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<meta http-equiv="Content-Type" content="<?php echo $this->getContentType() ?>" />
<?php
if(Mage::helper('mobiledetect')->isMobile() && !Mage::helper('mobiledetect')->isTablet()) {
    echo '<meta name="viewport" content="width=1170"><meta name="MobileOptimized" content="1170">';
}else {
    echo '<meta name="viewport" content="initial-scale=1.0, width=device-width" />';
}
?>
<title><?php echo $this->getTitle() ?></title>
<meta name="description" content="<?php echo htmlspecialchars($this->getDescription()) ?>" />
<meta name="keywords" content="<?php echo htmlspecialchars($this->getKeywords()) ?>" />
<meta name="robots" content="<?php echo htmlspecialchars($this->getRobots()) ?>" />
<link rel="icon" href="<?php echo $this->getFaviconFile(); ?>" type="image/x-icon" />
<link rel="shortcut icon" href="<?php echo $this->getFaviconFile(); ?>" type="image/x-icon" />
<!--[if lt IE 7]>
<script type="text/javascript">
//<![CDATA[
    var BLANK_URL = '<?php echo $this->helper('core/js')->getJsUrl('blank.html') ?>';
    var BLANK_IMG = '<?php echo $this->helper('core/js')->getJsUrl('spacer.gif') ?>';
//]]>
</script>
<![endif]-->
<?php echo $this->getCssJsHtml() ?>
<?php echo $this->getChildHtml() ?>
<?php echo $this->helper('core/js')->getTranslatorScript() ?>
<?php echo $this->getIncludes() ?>

<script>
function getQueryVar(variable)
{
       var query = window.location.search.substring(1);
       var vars = query.split("&");
       for (var i=0;i<vars.length;i++) {
               var pair = vars[i].split("=");
               if(pair[0] == variable){return pair[1];}
       }
       return "";
}

function changeUrl(page, url) {
  if (typeof (history.pushState) != "undefined") {
    var obj = { Page: page, Url: url };
    history.pushState(obj, obj.Page, obj.Url);
  } else {
    alert("Browser does not support HTML5.");
  }
}
var cat_attrs = [];
var datalayer=[];
</script>

<?php
if($_Crrentproduct = Mage::registry('current_product')) {
    ?>
    <script type="text/javascript">
      datalayer[{
            "sku":"<?php echo $_Crrentproduct->getSku();?>",
            "name":"<?php echo $_Crrentproduct->getName();?>",
            "category":"<?php echo Mage::getModel('catalog/category')->load($_Crrentproduct->getCategoryId())->getName();?>",
            "categoryId":"<?php echo $_Crrentproduct->getCategoryId();?>",
            "price":"<?php echo $_Crrentproduct->getFinalPrice();?>",
            "currency":"<?php echo Mage::app()->getStore()->getCurrentCurrencyCode();?>"
        }];
    
    </script>
<?php
}


 $request = $this->getRequest();
  $module = $request->getModuleName();
  $controller = $request->getControllerName();
  $action = $request->getActionName();
 if($module == 'ajax' && $controller == 'index' && $action == 'index')
 {
  $cart='';
    $cart = Mage::getModel('checkout/cart')->getQuote();
    echo "<script type='text/javascript'>
      datalayer[ \n";
      $dl=0;
    foreach ($cart->getAllVisibleItems() as $item) {
      $product = $item->getProduct();

        $productName = $item->getProduct()->getName();
        $productPrice = $item->getProduct()->getPrice();
        $productCurrency = Mage::app()->getStore()->getCurrentCurrencyCode();

          echo "{\n";
            echo "sku:'".$item->getProduct()->getSku()."',\n";
            echo "name:".$productName.",\n";
            echo "quantity:".$item->getQty().",\n";
            echo "price:".$productPrice.",\n";
            echo "currerncy:".$productCurrency;

            echo "\n}";
            if($dl<count($cart->getAllVisibleItems())-1){
              echo ",";
            }
            $dl++;
    }
    echo '];</script>';
 }
if(Mage::app()->getFrontController()->getAction()->getFullActionName()=='onestepcheckout_index_success'){

  $order = Mage::getSingleton('sales/order'); 
  $order->loadByIncrementId(Mage::getSingleton('checkout/session')->getLastRealOrderId());
  $_items = $order->getAllVisibleItems();

  echo "<script type='text/javascript'>
      datalayer[ \n";
      $dl=0;
    foreach ($_items as $item) {
      $product = $item->getProduct();

        $productName = $item->getProduct()->getName();
        $productPrice = $item->getProduct()->getPrice();
        $productCurrency = Mage::app()->getStore()->getCurrentCurrencyCode();

          echo "{\n";
            echo "sku:'".$item->getProduct()->getSku()."',\n";
            echo "name:".$productName.",\n";
            echo "quantity:".$item->getProduct()->getQty().",\n";
            echo "price:".$productPrice.",\n";
            echo "currerncy:".$productCurrency;

            echo "\n}";
            if($dl<count($_items)-1){
              echo ",";
            }
            $dl++;
    }
    echo '];</script>';
}
?>